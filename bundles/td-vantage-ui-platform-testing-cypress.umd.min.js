!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("moment")):"function"==typeof define&&define.amd?define("@td-vantage/ui-platform/testing/cypress",["exports","moment"],t):t(((e=e||self)["td-vantage"]=e["td-vantage"]||{},e["td-vantage"]["ui-platform"]=e["td-vantage"]["ui-platform"]||{},e["td-vantage"]["ui-platform"].testing=e["td-vantage"]["ui-platform"].testing||{},e["td-vantage"]["ui-platform"].testing.cypress={}),e.moment)}(this,(function(e,t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var o=Cypress.config("baseUrl"),r=Cypress.env("loginUrl");function s(e){var t=e.username,o=e.password;cy.request({url:r}).then((function(e){var r=document.createElement("html");r.innerHTML=e.body;var s=r.querySelector("#kc-form-login");s?cy.request({form:!0,method:"POST",url:s.action,followRedirect:!1,body:{username:t,password:o}}).then((function(){i()})):i()}))}function n(){cy.request("/api/user/logout")}function i(){cy.visit(o),cy.url().should("not.include",r),cy.url().should("include",o)}var c=["USER_SSO_ID","XSRF-TOKEN"];function a(){return cy.get("[ng-version]").should("exist"),cy.window().then((function(e){return new Cypress.Promise((function(t,o){var r=e.getAllAngularTestabilities();if(!r)return o(new Error("No testabilities. Is Angular loaded?"));var s=r.length;r.forEach((function(e){return e.whenStable((function(){0===--s&&t()}))}))}))}))}var u={unit:"unit",e2e:"e2e"};var l=["content-type","x-length","x-page","x-total","x-total-pages"],d=function(){function e(){this.mocking=!1,this.recording=!1}return e.prototype.setUp=function(e,o,r,n,i){var c=this;void 0===i&&(i=!1),cy.now("log","Test: "+e+"/"+o),this.testName=e,this.testType=o,cy.server(),this.timestamp=t().format("LTS"),this.urlMethodFixtureMap=new Map,this.recordedURLMethodFixtureMap=new Map,(Cypress.env("record")||i)&&(this.recording=!0,cy.now("log","Recording..."),["GET","POST","PUT","PATCH","DELETE"].forEach((function(e){cy.route({url:"**",method:e,onResponse:function(e){c.recordResponse(e)}})}))),(Cypress.env("mock")||o===u.unit)&&(cy.now("log","Mocking..."),this.mocking=!0),this.mocking&&!this.recording&&this.registerRoute(n),r.forEach((function(e){c.registerRoute("templates/"+e),c.registerRoute("templates/"+e+"/"+n)})),this.registerRoute("testspecific/"+e),Cypress.Commands.add("route2",(function(e){Cypress.env("mock")?(cy.now("log","Setting route to mock"),cy.route(e)):(cy.now("log"," Setting route to alias"),cy.route(e.url))})),cy.route({method:"GET",url:"/api/user/logout",status:200,response:{}}),this.mocking&&!this.recording?cy.visit("/"):cy.fixture("credentials/"+n).then((function(e){s(e)})),a()},e.prototype.registerRoute=function(e){var t=this,o=e+"/mockdata.json";cy.exec("if [ -f cypress/fixtures/"+o+" ]; then ls cypress/fixtures/"+o+"; fi").then((function(e){e.stdout&&cy.fixture(o).then((function(e){Object.keys(e).forEach((function(o){var r=e[o];Object.keys(r).forEach((function(e){var s=r[e],n=o+"|"+e,i=!1;s.forEach((function(r){if(t.mocking)void 0===t.urlMethodFixtureMap.get(n)&&(t.urlMethodFixtureMap.set(n,[]),i=!0),t.urlMethodFixtureMap.get(n).push(r),i&&t.registerMockRoute(o,e,r);else if(t.recording){var s={method:e,url:o,onResponse:function(e){t.recordResponse(e)}};cy.now("log","Registering recording route:"),cy.now("log","url/method: "+o+"/"+e),cy.route(s).as(r.alias)}else{s={method:e,url:o};cy.now("log","Registering alias route:"),cy.now("log","url/method: "+o+"/"+e),cy.now("log","alias: "+r.alias),cy.route(s).as(r.alias)}}))}))}))}))}))},e.prototype.registerMockRoute=function(e,t,o){var r=this,s={url:e,method:t,status:o.status,headers:o.headers,response:o.response,onResponse:function(o){var s=new URL(o.url).pathname+"|"+o.method,n=r.urlMethodFixtureMap.get(s);if(n.length>1){n.shift();var i=n[0];r.registerMockRoute(e,t,i)}}};cy.now("log","Registering mock route:"),cy.now("log","url/method: "+e+"/"+t),cy.now("log","alias: "+o.alias),cy.now("log","status: "+o.status),cy.now("log","headers: "+JSON.stringify(o.headers)),cy.now("log","response: "+JSON.stringify(o.response)),cy.route(s).as(o.alias)},e.prototype.recordResponse=function(e){var t=e.url.substring(Cypress.config("baseUrl").length),o=e.method,r={};Object.keys(e.response.headers).forEach((function(t){-1!==l.indexOf(t)&&(r[t]=e.response.headers[t])}));var s={alias:t+"|"+o,status:e.status,headers:r,response:e.response.body};this.recordedURLMethodFixtureMap[t]||(this.recordedURLMethodFixtureMap[t]={});var n=this.recordedURLMethodFixtureMap[t];n[o]||(n[o]=[]),cy.now("log","Recording response:"),cy.now("log","url/method: "+t+"/"+o),cy.now("log","response: "+JSON.stringify(s)),n[o].push(s)},e.prototype.tearDown=function(){this.recording&&(cy.now("log","Writing record fixture: cypress/recordings/"+this.testName+"/"+this.timestamp+"/mockdata.json"),cy.now("writeFile","cypress/recordings/"+this.testName+"/"+this.timestamp+"/mockdata.json",this.recordedURLMethodFixtureMap)),this.mocking||n()},e}();e.MockUtility=d,e.SSO_COOKIES=c,e.TestType=u,e.login=s,e.logout=n,e.waitForAngular=a,e.whiteListSSOCookies=function(){Cypress.Cookies.defaults({whitelist:c})},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=td-vantage-ui-platform-testing-cypress.umd.min.js.map