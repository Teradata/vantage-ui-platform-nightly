{"version":3,"file":"td-vantage-ui-platform-theme.umd.js","sources":["ng://@td-vantage/ui-platform/theme/theme.service.ts","ng://@td-vantage/ui-platform/theme/theme.module.ts"],"sourcesContent":["import { Injectable, Renderer2, Inject, RendererFactory2, Provider, Optional, SkipSelf } from '@angular/core';\nimport { fromEvent, BehaviorSubject, Observable, fromEventPattern, merge } from 'rxjs';\nimport { filter, map } from 'rxjs/operators';\nimport { DOCUMENT } from '@angular/common';\n\nexport const THEME_LOCAL_STORAGE_KEY: string = 'vantage.theme';\n\nexport enum VantageTheme {\n  DARK = 'dark-theme',\n  LIGHT = 'light-theme',\n}\n\nexport interface IVantageThemeMap {\n  [VantageTheme.DARK]?: any;\n  [VantageTheme.LIGHT]?: any;\n}\n\n@Injectable()\nexport class VantageThemeService {\n  private _renderer2: Renderer2;\n\n  private readonly _activeThemeSubject: BehaviorSubject<VantageTheme>;\n  private readonly preferDarkMediaQuery: MediaQueryList = window.matchMedia('(prefers-color-scheme: dark)');\n\n  public activeTheme$: Observable<VantageTheme>;\n  public darkTheme$: Observable<boolean>;\n  public lightTheme$: Observable<boolean>;\n\n  constructor(private rendererFactory: RendererFactory2, @Inject(DOCUMENT) private _document: any) {\n    const initialValue: VantageTheme =\n      <VantageTheme>localStorage.getItem(THEME_LOCAL_STORAGE_KEY) || this.checkOSPreference();\n\n    this._renderer2 = rendererFactory.createRenderer(undefined, undefined);\n    this._activeThemeSubject = new BehaviorSubject<VantageTheme>(initialValue);\n\n    this.activeTheme$ = this._activeThemeSubject.asObservable();\n    this.darkTheme$ = this._activeThemeSubject\n      .asObservable()\n      .pipe(map((theme: VantageTheme) => theme === VantageTheme.DARK));\n    this.lightTheme$ = this._activeThemeSubject\n      .asObservable()\n      .pipe(map((theme: VantageTheme) => theme === VantageTheme.LIGHT));\n\n    // apply initial theme\n    this.applyTheme(initialValue, false);\n\n    // observe media query change events\n    const mediaObserver: Observable<VantageTheme> = fromEventPattern<MediaQueryListEvent>(\n      this.preferDarkMediaQuery.addListener.bind(this.preferDarkMediaQuery),\n      this.preferDarkMediaQuery.removeListener.bind(this.preferDarkMediaQuery),\n    ).pipe(\n      map((event: MediaQueryListEvent) => {\n        return event.matches ? VantageTheme.DARK : VantageTheme.LIGHT;\n      }),\n    );\n\n    // account for storage events in other browser tabs\n    const storageObserver: Observable<VantageTheme> = fromEvent(window, 'storage').pipe(\n      filter((event: StorageEvent) => event.key === THEME_LOCAL_STORAGE_KEY),\n      map((event: StorageEvent) => (event.newValue ? (event.newValue as VantageTheme) : this.checkOSPreference())),\n    );\n\n    // apply theme on storage or media query change\n    merge(storageObserver, mediaObserver).subscribe((theme: VantageTheme) => this.applyTheme(theme));\n  }\n\n  private get _activeTheme(): VantageTheme {\n    return this._activeThemeSubject.getValue();\n  }\n\n  private set _activeTheme(theme: VantageTheme) {\n    this._activeThemeSubject.next(theme);\n  }\n\n  public get darkThemeIsActive(): boolean {\n    return this._activeTheme === VantageTheme.DARK;\n  }\n  public get lightThemeIsActive(): boolean {\n    return this._activeTheme === VantageTheme.LIGHT;\n  }\n\n  public activeTheme(): VantageTheme {\n    return this._activeTheme;\n  }\n\n  public applyLightTheme(): VantageTheme {\n    return this.applyTheme(VantageTheme.LIGHT);\n  }\n\n  public applyDarkTheme(): VantageTheme {\n    return this.applyTheme(VantageTheme.DARK);\n  }\n\n  public toggleTheme(): VantageTheme {\n    return this._activeTheme === VantageTheme.DARK ? this.applyLightTheme() : this.applyDarkTheme();\n  }\n\n  public map(mapObject: IVantageThemeMap, fallback?: any): Observable<any> {\n    return this.activeTheme$.pipe(map((value: VantageTheme) => (value in mapObject ? mapObject[value] : fallback)));\n  }\n\n  private applyTheme(theme: VantageTheme, saveSetting: boolean = true): VantageTheme {\n    this._renderer2.removeClass(\n      this._document.querySelector('html'),\n      theme === VantageTheme.DARK ? VantageTheme.LIGHT : VantageTheme.DARK,\n    );\n    this._renderer2.addClass(this._document.querySelector('html'), theme);\n\n    if (saveSetting) {\n      localStorage.setItem(THEME_LOCAL_STORAGE_KEY, theme);\n    }\n\n    return (this._activeTheme = theme);\n  }\n\n  private checkOSPreference(): VantageTheme {\n    // it should now be light-by-default\n    return this.preferDarkMediaQuery.matches ? VantageTheme.DARK : VantageTheme.LIGHT;\n  }\n}\n\nexport function VANTAGE_THEME_PROVIDER_FACTORY(\n  parent: VantageThemeService,\n  rendererFactory: RendererFactory2,\n  _document: any,\n): VantageThemeService {\n  return parent || new VantageThemeService(rendererFactory, _document);\n}\n\nexport const VANTAGE_THEME_PROVIDER: Provider = {\n  // If there is already a service available, use that. Otherwise, provide a new one.\n  provide: VantageThemeService,\n  deps: [[new Optional(), new SkipSelf(), VantageThemeService], [RendererFactory2], [DOCUMENT]],\n  useFactory: VANTAGE_THEME_PROVIDER_FACTORY,\n};\n","import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { VANTAGE_THEME_PROVIDER } from './theme.service';\n\n@NgModule({\n  imports: [CommonModule],\n  providers: [VANTAGE_THEME_PROVIDER],\n})\nexport class VantageThemeModule {}\n"],"names":["BehaviorSubject","map","fromEventPattern","fromEvent","filter","merge","Injectable","RendererFactory2","Inject","DOCUMENT","Optional","SkipSelf","NgModule","CommonModule"],"mappings":"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"}