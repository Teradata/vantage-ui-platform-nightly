{"version":3,"file":"td-vantage-ui-platform-auth.js","sources":["ng://@td-vantage/ui-platform/auth/token/token.service.ts","ng://@td-vantage/ui-platform/auth/session/session.service.ts","ng://@td-vantage/ui-platform/auth/guards/authentication.guard.ts","ng://@td-vantage/ui-platform/auth/auth.module.ts","ng://@td-vantage/ui-platform/auth/interceptors/authentication.interceptor.ts"],"sourcesContent":["import { Optional, SkipSelf, Provider } from '@angular/core';\nimport { HttpHeaders, HttpResponse } from '@angular/common/http';\n\nimport { Observable } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\nimport {\n  TdHttp,\n  TdPOST,\n  TdBody,\n  TdResponse,\n} from '@covalent/http';\n\nexport interface IToken {\n  access_token?: string;\n  refresh_token?: string;\n  expires_at?: string;\n  token_type?: string;\n  expires_in?: number;\n  token_in?: string;\n}\n\n@TdHttp({\n  baseUrl: '/api/user',\n  baseHeaders: new HttpHeaders({ 'Accept': 'application/json' }),\n})\nexport class VantageTokenService {\n\n  @TdPOST({\n    path: '/token',\n    options: {\n      observe: 'response',\n    },\n  })\n  create(@TdBody() user: { username: string, password: string },\n         @TdResponse() response?: Observable<HttpResponse<IToken>>): Observable<any> {\n    return response.pipe(\n      map((res: HttpResponse<IToken>) => {\n        let data: IToken = res.body;\n        let token: string = res.headers.get('X-AUTH-TOKEN') || data.access_token;\n        return { data: data, token: token };\n      }),\n    );\n  }\n}\n\nexport function VANTAGE_TOKEN_PROVIDER_FACTORY(parent: VantageTokenService): VantageTokenService {\n  return parent || new VantageTokenService();\n}\n\nexport const VANTAGE_TOKEN_PROVIDER: Provider = {\n  // If there is already a service available, use that. Otherwise, provide a new one.\n  provide: VantageTokenService,\n  deps: [[new Optional(), new SkipSelf(), VantageTokenService]],\n  useFactory: VANTAGE_TOKEN_PROVIDER_FACTORY,\n};\n","import { map, catchError } from 'rxjs/operators';\nimport { Provider, Optional, SkipSelf } from '@angular/core';\nimport { HttpHeaders, HttpResponse } from '@angular/common/http';\nimport { TdHttp, TdGET, TdResponse, TdPOST, TdParam } from '@covalent/http';\nimport { Observable, of } from 'rxjs';\n\nimport { tap, switchMap } from 'rxjs/operators';\n\nexport interface IUser {\n  username?: string;\n  password?: string;\n  email?: string;\n  local?: boolean;\n  admin?: boolean;\n  groups?: string[];\n  display_name?: string;\n  access_token?: string;\n  expires_at?: number;\n}\n\nexport interface ISessionUser {\n  user?: string;\n  valid?: boolean;\n  admin?: boolean;\n  groups?: string[];\n  expires_at?: string;\n}\n\n@TdHttp({\n  baseUrl: '/api/user',\n  baseHeaders: new HttpHeaders({\n    Accept: 'application/json',\n  }),\n})\nexport class VantageSessionService {\n\n  private _user: IUser;\n\n  get user(): IUser {\n    return this._user;\n  }\n\n  getInfo(): Observable<IUser> {\n    if (!this._user) {\n      return this._get().pipe(\n        switchMap((sessionUser: ISessionUser) => {\n          return this._getUser(sessionUser.user).pipe(\n            tap((u: IUser) => {\n              this._user = Object.assign({}, sessionUser, u);\n            },\n          ));\n        }),\n      );\n    } else {\n      return of(this._user);\n    }\n  }\n\n  async logout(): Promise<void> {\n    try {\n      return await this._logout().toPromise();\n    } catch (e) {\n      // ignore error\n    } finally {\n      document.cookie = 'XSRF-TOKEN=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';\n      window.location.reload();\n    }\n  }\n\n  /**\n   * gets the current sso logged in users information\n   */\n  @TdPOST({\n    path: '/token/validity?fields=user,groups',\n    options: {\n      observe: 'response',\n    },\n  })\n  private _get(\n    @TdResponse() response?: Observable<HttpResponse<any>>,\n  ): Observable<any> {\n    return response.pipe(\n      map((res: HttpResponse<ISessionUser>) => {\n        return res.body;\n      }),\n    );\n  }\n\n  @TdGET({\n    path: '/logout?session=true',\n    options: {\n      observe: 'response',\n    },\n  })\n  private _logout(\n    @TdResponse() response?: Observable<HttpResponse<any>>,\n  ): Observable<any> {\n    return response.pipe(\n      map((res: HttpResponse<any>) => {\n        return res;\n      }),\n    );\n  }\n\n  /**\n   * gets a single users information\n   */\n  @TdGET({\n    path: '/users/:username',\n    options: {\n      observe: 'response',\n    },\n  })\n  private _getUser(\n    @TdParam('username') id: string,\n    @TdResponse() response?: Observable<HttpResponse<any>>,\n  ): Observable<IUser> {\n    return response.pipe(\n      catchError((error: Response) => {\n        return of(error);\n      }),\n      map((res: HttpResponse<IUser>) => {\n        return <IUser>res.body;\n      }),\n    );\n  }\n}\n\nexport function VANTAGE_SESSION_PROVIDER_FACTORY(parent: VantageSessionService): VantageSessionService {\n  return parent || new VantageSessionService();\n}\n\nexport const VANTAGE_SESSION_PROVIDER: Provider = {\n  // If there is already a service available, use that. Otherwise, provide a new one.\n  provide: VantageSessionService,\n  deps: [[new Optional(), new SkipSelf(), VantageSessionService]],\n  useFactory: VANTAGE_SESSION_PROVIDER_FACTORY,\n};\n","import { Injectable } from '@angular/core';\nimport { ActivatedRouteSnapshot, RouterStateSnapshot, CanActivate } from '@angular/router';\n\nimport { VantageSessionService } from '../session/session.service';\n\n@Injectable()\nexport class VantageAuthenticationGuard implements CanActivate {\n\n  constructor(private _sessionService: VantageSessionService) {}\n\n  getCookiebyName(name: string): string {\n    let pair: string[] = document.cookie.match(new RegExp(name + '=([^;]+)'));\n    return !!pair ? pair[1] : undefined;\n  }\n\n  async canActivate(next: ActivatedRouteSnapshot, state: RouterStateSnapshot): Promise<boolean> {\n    let xsrfToken: string = this.getCookiebyName('XSRF-TOKEN');\n    if (!xsrfToken) {\n      window.location.href = '/start-login';\n      return false;\n    } else {\n      try {\n        await this._sessionService.getInfo().toPromise();\n      } catch (e) {\n        this._sessionService.logout();\n        return false;\n      }\n    }\n    return true;\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\n\nimport { VANTAGE_TOKEN_PROVIDER } from './token/token.service';\nimport { VANTAGE_SESSION_PROVIDER } from './session/session.service';\n\nimport { VantageAuthenticationGuard } from './guards/authentication.guard';\n\n@NgModule({\n  imports: [\n    CommonModule,\n  ],\n  providers: [\n    VANTAGE_TOKEN_PROVIDER,\n    VANTAGE_SESSION_PROVIDER,\n    VantageAuthenticationGuard,\n  ],\n})\nexport class VantageAuthenticationModule {\n\n}\n","import { Injectable } from '@angular/core';\nimport { HttpErrorResponse } from '@angular/common/http';\n\nimport { Observable } from 'rxjs';\nimport { catchError } from 'rxjs/operators';\n\nimport { ITdHttpInterceptor } from '@covalent/http';\n\n/* 4XX errors */\nconst UNAUTHORIZED: number = 401;\nconst PAYLOAD_TOO_LARGE: number = 413;\n\n/* 5XX errors */\nconst SERVICE_UNAVAILABLE: number = 503;\nconst GATEWAY_TIMEOUT: number = 504;\n\n@Injectable()\nexport class VantageAuthenticationInterceptor implements ITdHttpInterceptor {\n\n  onResponseError(error: any): any {\n    if (error.status === UNAUTHORIZED) {\n      // expire the xsrf cookie and reload page\n      document.cookie = 'XSRF-TOKEN=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';\n      window.location.reload();\n    } \n    return error;\n  }\n\n  handleResponse(observable: Observable<any>): Observable<any> {\n    return observable.pipe(\n      catchError((e: any) => {\n        // check error and do something\n        if (e instanceof HttpErrorResponse) {\n          // do something if its response error\n         return this.onResponseError(e);\n        }\n      }),\n    );\n  }\n}\n"],"names":["tslib_1.__decorate","tslib_1.__param"],"mappings":"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"}