{"version":3,"sources":["ng://@td-vantage/ui-platform/theme/theme.service.ts","ng://@td-vantage/ui-platform/theme/theme.module.ts"],"names":["DARK","LIGHT","VantageThemeService","rendererFactory","_document","_this","this","preferDarkMediaQuery","window","matchMedia","initialValue","localStorageTheme","checkOSPreference","_renderer2","createRenderer","undefined","_activeThemeSubject","BehaviorSubject","activeTheme$","asObservable","darkTheme$","pipe","map","theme","VantageTheme","lightTheme$","applyTheme","mediaObserver","fromEventPattern","addListener","bind","removeListener","event","matches","storageObserver","fromEvent","filter","key","newValue","merge","subscribe","addEventListener","pageTransition","localStorageDiffersActiveTheme","_activeTheme","persisted","Object","defineProperty","prototype","getValue","next","activeTheme","applyLightTheme","applyDarkTheme","toggleTheme","mapObject","fallback","value","localStorage","getItem","saveSetting","removeClass","querySelector","addClass","setItem","Injectable","RendererFactory2","Inject","args","DOCUMENT","VANTAGE_THEME_PROVIDER_FACTORY","parent","VANTAGE_THEME_PROVIDER","provide","deps","Optional","SkipSelf","useFactory","VantageThemeModule","NgModule","imports","CommonModule","providers"],"mappings":"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","sourcesContent":["import { Injectable, Renderer2, Inject, RendererFactory2, Provider, Optional, SkipSelf } from '@angular/core';\nimport { fromEvent, BehaviorSubject, Observable, fromEventPattern, merge } from 'rxjs';\nimport { filter, map } from 'rxjs/operators';\nimport { DOCUMENT } from '@angular/common';\n\nexport const THEME_LOCAL_STORAGE_KEY: string = 'vantage.theme';\n\nexport enum VantageTheme {\n  DARK = 'dark-theme',\n  LIGHT = 'light-theme',\n}\n\nexport interface IVantageThemeMap {\n  [VantageTheme.DARK]?: any;\n  [VantageTheme.LIGHT]?: any;\n}\n\n@Injectable()\nexport class VantageThemeService {\n  private _renderer2: Renderer2;\n\n  private readonly _activeThemeSubject: BehaviorSubject<VantageTheme>;\n  private readonly preferDarkMediaQuery: MediaQueryList = window.matchMedia('(prefers-color-scheme: dark)');\n\n  public activeTheme$: Observable<VantageTheme>;\n  public darkTheme$: Observable<boolean>;\n  public lightTheme$: Observable<boolean>;\n\n  constructor(private rendererFactory: RendererFactory2, @Inject(DOCUMENT) private _document: any) {\n    const initialValue: VantageTheme = this.localStorageTheme() || this.checkOSPreference();\n\n    this._renderer2 = rendererFactory.createRenderer(undefined, undefined);\n    this._activeThemeSubject = new BehaviorSubject<VantageTheme>(initialValue);\n\n    this.activeTheme$ = this._activeThemeSubject.asObservable();\n    this.darkTheme$ = this._activeThemeSubject\n      .asObservable()\n      .pipe(map((theme: VantageTheme) => theme === VantageTheme.DARK));\n    this.lightTheme$ = this._activeThemeSubject\n      .asObservable()\n      .pipe(map((theme: VantageTheme) => theme === VantageTheme.LIGHT));\n\n    // apply initial theme\n    this.applyTheme(initialValue, false);\n\n    // observe media query change events\n    const mediaObserver: Observable<VantageTheme> = fromEventPattern<MediaQueryListEvent>(\n      this.preferDarkMediaQuery.addListener.bind(this.preferDarkMediaQuery),\n      this.preferDarkMediaQuery.removeListener.bind(this.preferDarkMediaQuery),\n    ).pipe(\n      map((event: MediaQueryListEvent) => {\n        return event.matches ? VantageTheme.DARK : VantageTheme.LIGHT;\n      }),\n    );\n\n    // account for storage events in other browser tabs\n    const storageObserver: Observable<VantageTheme> = fromEvent(window, 'storage').pipe(\n      filter((event: StorageEvent) => event.key === THEME_LOCAL_STORAGE_KEY),\n      map((event: StorageEvent) => (event.newValue ? (event.newValue as VantageTheme) : this.checkOSPreference())),\n    );\n\n    // apply theme on storage or media query change\n    merge(storageObserver, mediaObserver).subscribe((theme: VantageTheme) => this.applyTheme(theme));\n\n    // account for cached navigation\n    // needed for Firefox BFCache\n    window.addEventListener('pageshow', (pageTransition: PageTransitionEvent) => {\n      const localStorageTheme: VantageTheme = this.localStorageTheme();\n      const localStorageDiffersActiveTheme: boolean = localStorageTheme && localStorageTheme !== this._activeTheme;\n\n      if (pageTransition.persisted && localStorageDiffersActiveTheme) {\n        this.applyTheme(localStorageTheme);\n      }\n    });\n  }\n\n  private get _activeTheme(): VantageTheme {\n    return this._activeThemeSubject.getValue();\n  }\n\n  private set _activeTheme(theme: VantageTheme) {\n    this._activeThemeSubject.next(theme);\n  }\n\n  public get darkThemeIsActive(): boolean {\n    return this._activeTheme === VantageTheme.DARK;\n  }\n  public get lightThemeIsActive(): boolean {\n    return this._activeTheme === VantageTheme.LIGHT;\n  }\n\n  public activeTheme(): VantageTheme {\n    return this._activeTheme;\n  }\n\n  public applyLightTheme(): VantageTheme {\n    return this.applyTheme(VantageTheme.LIGHT);\n  }\n\n  public applyDarkTheme(): VantageTheme {\n    return this.applyTheme(VantageTheme.DARK);\n  }\n\n  public toggleTheme(): VantageTheme {\n    return this._activeTheme === VantageTheme.DARK ? this.applyLightTheme() : this.applyDarkTheme();\n  }\n\n  public map(mapObject: IVantageThemeMap, fallback?: any): Observable<any> {\n    return this.activeTheme$.pipe(map((value: VantageTheme) => (value in mapObject ? mapObject[value] : fallback)));\n  }\n\n  private localStorageTheme(): VantageTheme {\n    return localStorage.getItem(THEME_LOCAL_STORAGE_KEY) as VantageTheme;\n  }\n\n  private applyTheme(theme: VantageTheme, saveSetting: boolean = true): VantageTheme {\n    this._renderer2.removeClass(\n      this._document.querySelector('html'),\n      theme === VantageTheme.DARK ? VantageTheme.LIGHT : VantageTheme.DARK,\n    );\n    this._renderer2.addClass(this._document.querySelector('html'), theme);\n\n    if (saveSetting) {\n      localStorage.setItem(THEME_LOCAL_STORAGE_KEY, theme);\n    }\n\n    return (this._activeTheme = theme);\n  }\n\n  private checkOSPreference(): VantageTheme {\n    // it should now be light-by-default\n    return this.preferDarkMediaQuery.matches ? VantageTheme.DARK : VantageTheme.LIGHT;\n  }\n}\n\nexport function VANTAGE_THEME_PROVIDER_FACTORY(\n  parent: VantageThemeService,\n  rendererFactory: RendererFactory2,\n  _document: any,\n): VantageThemeService {\n  return parent || new VantageThemeService(rendererFactory, _document);\n}\n\nexport const VANTAGE_THEME_PROVIDER: Provider = {\n  // If there is already a service available, use that. Otherwise, provide a new one.\n  provide: VantageThemeService,\n  deps: [[new Optional(), new SkipSelf(), VantageThemeService], [RendererFactory2], [DOCUMENT]],\n  useFactory: VANTAGE_THEME_PROVIDER_FACTORY,\n};\n","import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { VANTAGE_THEME_PROVIDER } from './theme.service';\n\n@NgModule({\n  imports: [CommonModule],\n  providers: [VANTAGE_THEME_PROVIDER],\n})\nexport class VantageThemeModule {}\n"]}