!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs/operators"),require("@covalent/http"),require("@ngx-translate/core"),require("rxjs"),require("@angular/common")):"function"==typeof define&&define.amd?define("@td-vantage/ui-platform/sqle",["exports","@angular/core","@angular/common/http","rxjs/operators","@covalent/http","@ngx-translate/core","rxjs","@angular/common"],t):t(((e=e||self)["td-vantage"]=e["td-vantage"]||{},e["td-vantage"]["ui-platform"]=e["td-vantage"]["ui-platform"]||{},e["td-vantage"]["ui-platform"].sqle={}),e.ng.core,e.ng.common.http,e.rxjs.operators,e.covalent.http,e.core$1,e.rxjs,e.ng.common)}(this,(function(e,t,n,r,a,o,i,s){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var u=function(){return(u=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function c(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,o=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)i.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return i}var p=function(){function e(e){this._http=e}return e.prototype.querySystem=function(e,t){var a=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds?(a=a.set("X-Auth-Credentials","Basic "+e.creds),t.logMech=e.system.system_attributes.attributes.log_mech||"DEFAULT"):t.logMech="JWT",t.clientId="VANTAGE.EDITOR",this._http.post("/api/query/tdrest/systems/"+e.system.nickname+"/queries",t,{headers:a}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.prototype.getTableInfo=function(e,t,a){var o=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds&&(o=o.set("X-Auth-Credentials","Basic "+e.creds)),this._http.get("/api/query/systems/"+e.system.nickname+"/databases/"+t+"/tables/"+a,{headers:o}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.prototype.getViewInfo=function(e,t,a){var o=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds&&(o=o.set("X-Auth-Credentials","Basic "+e.creds)),this._http.get("/api/query/systems/"+e.system.nickname+"/databases/"+t+"/views/"+a,{headers:o}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.prototype.getQuery=function(e,t){var a=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds&&(a=a.set("X-Auth-Credentials","Basic "+e.creds)),this._http.get("/api/query/tdrest/systems/"+e.system.nickname+"/queries/"+t,{headers:a}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.prototype.getQueries=function(e,t){var a=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds&&(a=a.set("X-Auth-Credentials","Basic "+e.creds)),this._http.get("/api/query/tdrest/systems/"+e.system.nickname+"/queries?session="+t,{headers:a}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.prototype.getQueryResult=function(e,t){var a=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds&&(a=a.set("X-Auth-Credentials","Basic "+e.creds)),this._http.get("/api/query/tdrest/systems/"+e.system.nickname+"/queries/"+t+"/results",{headers:a}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.prototype.deleteQuery=function(e,t){var a=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds&&(a=a.set("X-Auth-Credentials","Basic "+e.creds)),this._http.delete("/api/query/tdrest/systems/"+e.system.nickname+"/queries/"+t,{headers:a}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.prototype.createSession=function(e){var t={autoCommit:"true",transactionMode:"TERA",charSet:"UTF8"},a=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds?(a=a.set("X-Auth-Credentials","Basic "+e.creds),t.logMech=e.system.system_attributes.attributes.log_mech||"DEFAULT"):t.logMech="JWT",this._http.post("/api/query/tdrest/systems/"+e.system.nickname+"/sessions",t,{headers:a}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.prototype.deleteSession=function(e,t){var a=(new n.HttpHeaders).append("Accept","application/vnd.com.teradata.rest-v1.0+json").append("Content-Type","application/json");return e.creds&&(a=a.set("X-Auth-Credentials","Basic "+e.creds)),this._http.delete("/api/query/tdrest/systems/"+e.system.nickname+"/sessions/"+t,{headers:a}).pipe(r.catchError((function(e){throw e.error})),r.map((function(e){return e})))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:a.TdHttpService}]},e}();function m(e,t){return e||new p(t)}var l={provide:p,deps:[[new t.Optional,new t.SkipSelf,p],a.TdHttpService],useFactory:m},d=function(){function e(e){this._queryService=e}return Object.defineProperty(e.prototype,"current",{get:function(){try{return JSON.parse(sessionStorage.getItem("vantage.editor.connection"))}catch(e){return}},enumerable:!0,configurable:!0}),e.prototype.disconnect=function(){sessionStorage.removeItem("vantage.editor.connection")},e.prototype.connect=function(e){var t=this;return this.disconnect(),this._queryService.querySystem(e,{query:"SELECT 1;"}).pipe(r.tap((function(){return t.store(e)})),r.mapTo(e))},e.prototype.store=function(e){var t=e.system,n=e.creds;sessionStorage.setItem("vantage.editor.connection",JSON.stringify({system:t,creds:n}))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:p}]},e}();function y(e,t){return e||new d(t)}var f={provide:d,deps:[[new t.Optional,new t.SkipSelf,d],p],useFactory:y};var S="RESULT_SET_READY",b=function(){function e(e,t,n){this.connectionService=e,this.queryService=t,this.translate=n,this.queryStatus=new i.BehaviorSubject(void 0),this.queryStatus$=this.queryStatus.asObservable(),this.queryStack=[]}return e.prototype.cancelLastQuery=function(){var e=this.queryStack.pop();return this.deleteSpooledQuery(e)},e.prototype.getRunningInfo=function(){return this.queryStatus$},e.prototype.querySystem=function(e){var t=this;return this.queryService.querySystem(this.connectionService.current,u(u({},e),{spooledResultSet:!0})).pipe(r.tap((function(e){return t.queryStack.push(e.id)})),r.switchMap((function(e){return t.exponentialBackOffInterval(1e4,e.id)})),r.switchMap((function(e){return t.queryService.getQuery(t.connectionService.current,e.toString()).pipe(r.map((function(e){return e.queryState})),r.tap((function(e){return t.queryStatus.next(e)})),r.map((function(t){return[e,t]})))})),r.skipWhile((function(e){var t=c(e,2);t[0];return t[1]!==S})),r.take(1),r.switchMap((function(e){var n=c(e,1)[0];return t.queryService.getQueryResult(t.connectionService.current,n).pipe(r.map((function(e){return[n,e]})),r.tap((function(){return t.queryStack.pop()})),r.catchError((function(e){return i.throwError(u(u(u({},e),{id:n}),{detailMessage:"Error "+e.error.error+": "+e.error.message}))})))})),r.map((function(e){var t=c(e,2);t[0];return t[1]})))},e.prototype.exponentialBackOffInterval=function(e,t){var n=this;return i.of(0).pipe(r.expand((function(t){return i.timer(n.calcInterval(t,e)).pipe(r.mapTo(t+1))})),r.mapTo(t))},e.prototype.calcInterval=function(e,t){var n=2e3*Math.pow(1.4,e);return Math.min(n,t)},e.prototype.deleteSpooledQuery=function(e){var t=this;this.queryService.deleteQuery(this.connectionService.current,e).subscribe(void 0,(function(e){throw new Error(t.translate.instant("SPOOLED_QUERY_COULD_NOT_BE_DELETED",{error:JSON.stringify(e)}))}))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:d},{type:p},{type:o.TranslateService}]},e}();function v(e,t,n,r){return e||new b(t,n,r)}var T={provide:b,deps:[[new t.Optional,new t.SkipSelf,b],d,p,o.TranslateService],useFactory:v},h=["DBC","dbcmngr","SQLJ","SystemFe","SysAdmin","SYSBAR","SYSJDBC","SYSLIB","SYSUDTLIB","TDMaps","TD_SERVER_DB","TD_SYSFNLIB","TD_SYSXML","Sys_Calendar"];var E=function(){function e(e){this._queryService=e}return e.prototype.getViewHelp=function(e,t,n){var a=this,o="\n      LOCK ROW FOR ACCESS\n      SELECT CAST(COUNT(*) AS BIGINT) as cnt\n      FROM "+t+"."+n+";\n      SHOW VIEW "+t+"."+n+";\n    ";return this._queryService.getViewInfo(e,t,n).pipe(r.map((function(e){return e.columns.map((function(t){return{comment:t.remarks,type:"column",columnType:t.type,name:t.name,database:e.database,table:e.name}}))})),r.switchMap((function(i){return a._queryService.querySystem(e,{query:o}).pipe(r.map((function(e){var r,a="";e.results[1].data.forEach((function(e){a+=e["Request Text"]})),e.results[0].data.forEach((function(e){r=e.cnt}));var o=i.map((function(e){return{columnName:e.name,type:e.columnType}}));return{database:t,view:n,columns:o,count:r,ddlStatement:a}})))})))},e.prototype.getTableHelp=function(e,t,n){var a=this,o="\n      LOCK ROW FOR ACCESS\n      SELECT CAST(COUNT(*) AS BIGINT) as cnt\n      FROM "+t+"."+n+";\n      SHOW TABLE "+t+"."+n+";\n    ";return this._queryService.getTableInfo(e,t,n).pipe(r.map((function(e){return e.columns.map((function(t){return{comment:t.remarks,type:"column",columnType:t.type,name:t.name,database:e.database,table:e.name}}))})),r.switchMap((function(i){return a._queryService.querySystem(e,{query:o}).pipe(r.map((function(e){var r,a="";e.results[1].data.forEach((function(e){a+=e["Request Text"]})),e.results[0].data.forEach((function(e){r=e.cnt}));var o=i.map((function(e){return{columnName:e.name,type:e.columnType}}));return{database:t,table:n,columns:o,count:r,ddlStatement:a}})))})))},e.prototype.getDatabaseFunction=function(e,t){var n="\n      HELP 'SQL "+t+"';\n    ";return this._queryService.querySystem(e,{query:n}).pipe(r.map((function(e){return e.results[0].data.map((function(e){return e["On-Line Help"]})).join(" ")})))},e.prototype.getDatabaseFunctions=function(e){return this._queryService.querySystem(e,{query:"\n      HELP 'SQL';\n    "}).pipe(r.map((function(e){var t=e.results[0].data.map((function(e){return e["On-Line Help"]})).join(" "),n=t.indexOf("FUNCTIONS")+12;return(t=t.substr(n,t.length)).split(" ").filter((function(e){return e})).map((function(e){return{name:e}}))})))},e.prototype.getAnalyticalFunctions=function(e){return this._queryService.querySystem(e,{query:'\n      HELP FOREIGN SCHEMA "public"@coprocessor;\n    '}).pipe(r.map((function(e){return e.results[0].data.map((function(e){return{name:e.objectname}}))})))},e.prototype.getAnalyticalFunction=function(e,t){var n='\n      HELP FOREIGN FUNCTION "public"."'+t+'"@coprocessor;\n    ';return this._queryService.querySystem(e,{query:n}).pipe(r.map((function(e){for(var t="",n="",r="",a="",o="",i="",s=e.results[0].data.map((function(e){return e["Function Help"]})),u=0;u<s.length;u++){var c=s[u];if(c.indexOf("Function Name:")>-1)for(u++;u<s.indexOf("");u++)t+=s[u]+"\n";else if(c.indexOf("Short Description:")>-1)for(u++;u<s.indexOf("");u++)n+=s[u]+"\n";else if(c.indexOf("Long Description:")>-1)for(u++;u<s.indexOf("");u++)r+=s[u]+"\n";else if(c.indexOf("Usage Syntax:")>-1)for(u++;u<s.indexOf("");u++)a+=s[u]+"\n";else if(c.indexOf("Input Columns:")>-1)for(u++;u<s.indexOf("");u++)o+=s[u]+"\n";else if(c.indexOf("Output Columns:")>-1)for(u++;u<s.indexOf("");u++)i+=s[u]+"\n";else s.indexOf("")>-1&&(u=s.indexOf(""),s[u]=void 0)}return{functionName:t,shortDescription:n,longDescription:r,usageSyntax:a,inputColumns:o,outputColumns:i}})))},e.prototype.resultSetPredicate=function(e){return e.results[0].data.map((function(e){return{name:e.TableName,requestText:e.RequestText,comment:e.CommentString,kind:e.TableKind}}))},e.prototype.getStoredProcedures=function(e){return this._queryService.querySystem(e,{query:"\n      SELECT DataBaseName, TableName, TableKind, RequestText, CommentString FROM dbc.tablesvx\n      WHERE TableKind = 'P'\n      ORDER BY TableName ASC;\n    "}).pipe(r.map(this.resultSetPredicate))},e.prototype.getExternalStoredProcedures=function(e){return this._queryService.querySystem(e,{query:"\n      SELECT DataBaseName, TableName, TableKind, RequestText, CommentString FROM dbc.tablesvx\n      WHERE TableKind = 'E'\n      ORDER BY TableName ASC;\n    "}).pipe(r.map(this.resultSetPredicate))},e.prototype.getMacros=function(e){return this._queryService.querySystem(e,{query:"\n      SELECT DataBaseName, TableName, TableKind, RequestText, CommentString FROM dbc.tablesvx\n      WHERE TableKind = 'M'\n      ORDER BY TableName ASC;\n    "}).pipe(r.map(this.resultSetPredicate))},e.prototype.functionsvxPredicate=function(e){return e.results[0].data.map((function(e){return{database:e.DatabaseName,name:e.SpecificName,paramNumber:e.NumParameters,paramDataTypes:e.ParameterDataTypes,requestText:e.RequestText,commentString:e.CommentString,kind:e.TableKind}}))},e.prototype.getTableOperators=function(e){return this._queryService.querySystem(e,{query:"\n      SELECT func.DatabaseName, func.FunctionName, func.SpecificName, func.NumParameters,\n      func.ParameterDataTypes, tbl.RequestText, tbl.CommentString, tbl.TableKind\n      FROM dbc.functionsvx as func\n      INNER JOIN dbc.tablesvx as tbl\n      ON tbl.TableName = func.SpecificName\n      AND tbl.DataBaseName = func.DatabaseName\n      WHERE FunctionType = 'L'\n      ORDER BY func.FunctionName ASC;\n    "}).pipe(r.map(this.functionsvxPredicate))},e.prototype.getTableFunctions=function(e){return this._queryService.querySystem(e,{query:"\n      SELECT func.DatabaseName, func.FunctionName, func.SpecificName, func.NumParameters,\n      func.ParameterDataTypes, tbl.RequestText, tbl.CommentString, tbl.TableKind\n      FROM dbc.functionsvx as func\n      INNER JOIN dbc.tablesvx as tbl\n      ON tbl.TableName = func.SpecificName\n      AND tbl.DataBaseName = func.DatabaseName\n      WHERE FunctionType = 'R'\n      ORDER BY func.FunctionName ASC;\n    "}).pipe(r.map(this.functionsvxPredicate))},e.prototype.getForeignServers=function(e){return this._queryService.querySystem(e,{query:"\n      SELECT TableName, TableKind FROM DBC.TABLESVX\n      WHERE DATABASENAME = 'TD_SERVER_DB' AND\n      TABLEKIND = 'K' AND\n      TableName <> 'coprocesor';\n    "}).pipe(r.map((function(e){return e.results[0].data.map((function(e){return{name:e.TableName,kind:e.TableKind}}))})))},e.prototype.getForeignSchemas=function(e,t){var n="\n      HELP FOREIGN SERVER "+t+";\n    ";return this._queryService.querySystem(e,{query:n}).pipe(r.map((function(e){return e.results[0].data.map((function(e){return{name:e.Schema,kind:"NONE"}}))})))},e.prototype.getForeignTables=function(e,t,n){var a='\n      HELP FOREIGN DATABASE "'+n+'"@'+t+";\n    ";return this._queryService.querySystem(e,{query:a}).pipe(r.map((function(e){return e.results[0].data.map((function(e){return{name:e.Table,kind:"NONE"}}))})))},e.prototype.getForeignColumns=function(e,t,n,a){var o='\n      HELP FOREIGN TABLE "'+n+'"."'+a+'"@'+t+";\n    ";return this._queryService.querySystem(e,{query:o}).pipe(r.map((function(e){return e.results[0].data.map((function(e){return{name:e.Column,type:e.Type}}))})))},e.prototype.getDatabases=function(e){return this._queryService.querySystem(e,{query:"SELECT databasename, PermSpace, SpoolSpace, TempSpace, CommentString, DBKind FROM dbc.databasesVX ORDER BY databasename;"}).pipe(r.map((function(e){return e.results[0].data.map((function(e){return{name:e.DatabaseName||e.schemaname,type:"U"===e.DBKind?"user":"database",permSpace:e.PermSpace,spoolSpace:e.SpoolSpace,tempSpace:e.TempSpace,comment:e.CommentString}}))})))},e.prototype.getDatabaseObjects=function(e,t){var n="SELECT DataBaseName, TableName, TableKind, CommentString FROM dbc.tablesvx\n       WHERE TableKind in ('T', 'O', 'V') AND DataBaseName = '"+t+"' ORDER BY TableName ASC;";return this._queryService.querySystem(e,{query:n}).pipe(r.map((function(e){return e.results[0].data.map((function(e){var t=e.TableKind||e.tablekind;return{kind:e.TableKind||e.tablekind,type:"V"===t?"view":"table",name:e.TableName||e.tablename,database:e.DataBaseName||e.databasename,comment:e.CommentString}}))})))},e.prototype.getTableColumns=function(e,t,n,a){return"table"===e?this._queryService.getTableInfo(t,n,a).pipe(r.map((function(e){return e.columns.map((function(t){return{comment:t.remarks,type:"column",columnType:t.type,name:t.name,database:e.database,table:e.name}}))}))):"view"===e?this._queryService.getViewInfo(t,n,a).pipe(r.map((function(e){return e.columns.map((function(t){return{comment:t.remarks,type:"column",columnType:t.type,name:t.name,database:e.database,table:e.name}}))}))):void 0},e.prototype.search=function(e,t,n){void 0===n&&(n={databases:!0,objects:!0,columns:!0});var a=[];if(n.databases){var o="\n        SELECT\n            DatabaseName as objectName,\n            'database' as objectType,\n            DBKind as kind,\n            CommentString\n        FROM dbc.databasesvx\n        WHERE DatabaseName LIKE '%"+t+"%'\n        AND DataBaseName NOT IN ('"+h.join("', '")+"')\n      ";a.push(o)}if(n.objects){var i="\n        SELECT\n            DataBaseName || '~|~' || TableName as objectName,\n            'object' as objectType,\n            TableKind as kind,\n            CommentString\n        FROM dbc.tablesvx\n        WHERE TableKind in ('T', 'O', 'V')\n        AND TableName LIKE '%"+t+"%'\n        AND DataBaseName NOT IN ('"+h.join("', '")+"')\n      ";a.push(i)}if(n.objects){var s="\n        SELECT\n            DataBaseName || '~|~' || TableName || '~|~' || ColumnName as objectName,\n            'column' as objectType,\n            ColumnType as kind,\n            CommentString\n        FROM dbc.columnsVX\n        WHERE columnname LIKE '%"+t+"%'\n        AND DataBaseName NOT IN ('"+h.join("', '")+"')\n      ";a.push(s)}var u="\n      WITH quick_search AS (\n          "+a.join("UNION")+"\n      )\n      SELECT * FROM quick_search\n      ORDER BY 1\n      SAMPLE 100;\n    ";return this._queryService.querySystem(e,{query:u}).pipe(r.map((function(e){return e.results[0].data.map((function(e){var t=e.kind;t="column"===e.objectType?"column":"database"===e.objectType?"D"===t?"database":"user":"V"===t?"view":"table";for(var n=[],r=e.objectName.split("~|~"),a=0;a<r.length-1;a++)n.push('"'+r[a]+'"');return{parent:n.join("."),name:r[r.length-1],kind:t,type:e.objectType,comment:e.CommentString}}))})))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:p}]},e}();function N(e,t){return e||new E(t)}var q={provide:E,deps:[[new t.Optional,new t.SkipSelf,E],p],useFactory:N},O=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{imports:[s.CommonModule],providers:[f,q,l,T]}]}],e}();e.VANTAGE_CONNECTION_PROVIDER=f,e.VANTAGE_CONNECTION_PROVIDER_FACTORY=y,e.VANTAGE_DICTIONARY_PROVIDER=q,e.VANTAGE_DICTIONARY_PROVIDER_FACTORY=N,e.VANTAGE_QUERY_PROVIDER=l,e.VANTAGE_QUERY_PROVIDER_FACTORY=m,e.VANTAGE_SPOOLED_QUERY_PROVIDER=T,e.VANTAGE_SPOOLED_QUERY_PROVIDER_FACTORY=v,e.VantageConnectionService=d,e.VantageDictionaryService=E,e.VantageQueryService=p,e.VantageSQLEModule=O,e.VantageSpooledQueryService=b,e.sysDatabases=h,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=td-vantage-ui-platform-sqle.umd.min.js.map